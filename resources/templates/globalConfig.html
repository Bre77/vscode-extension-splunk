<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <title>Config Preview</title>
</head>

<body style="font-size: 0.7rem;">
    <div >
        <nav class="navbar navbar-expand-lg bg-success">
            <div class="container" id="main-nav">
            </div>
        </nav>
    </div>
    <hr>
    <div id="config-container" hidden>
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container" id="config-tab">
            </div>
        </nav>
    </div>
    <hr />
    <p>Form Fields:</p>
    <div id="form-container">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW"
        crossorigin="anonymous"></script>
    <script>
        let activeForm = '';
        let showConfigTab = true;
        let forms = {};

        const toggleConfigNav = (show=true) => {
            document.getElementById("config-container").hidden = !show
            hideForm()
        }

        const hideForm = () => {
            if (activeForm && forms[activeForm]) {
                forms[activeForm].hidden = true
            }
        }

        const showForm = formName => {
            hideForm()
            if (forms[formName]) {
                forms[formName].hidden = false
            }
            activeForm = formName
        }

        const updateMainNav = (pages) => {
            const mainNavContainer = document.getElementById('main-nav')
            mainNavContainer.innerHTML = ''
            Object.keys(pages).forEach((page) => {
                const a = document.createElement("a")
                a.innerText = page
                a.className = "nav-link text-white"
                a.setAttribute("href", "#");
                a.style.fontSize = '0.9rem'
                a.setAttribute("href", "#")
                mainNavContainer.append(a)
                a.onclick = () => {
                    if (page === "configuration") {
                        toggleConfigNav(true)
                    } else {
                        toggleConfigNav(false);
                    }
                }
            })
        }

        function updateConfigTabs (tabs) {
            const configTab = document.getElementById("config-tab");
            configTab.innerHTML = ''
            tabs.forEach((tab) => {
                const a = document.createElement("a");
                a.innerText = tab.title;
                a.className = "nav-link text-dark";
                a.setAttribute("href", "#");
                a.style.fontSize = '0.8rem'
                a.onclick = () => {
                    showForm(tab.name)
                    activeForm = tab.name
                }
                configTab.append(a)
            })
            toggleConfigNav(true)
        }
        
        function updateEntityForm (entities, name) {
            const form = document.createElement("form")
            form.hidden = true
            form.id = name;
            document.getElementById("form-container").append(form)
            forms[name]=form
            entities.forEach((entity) => {
                const div = document.createElement("div")
                div.className = "mb-3"
                form.append(div)
                if (entity.type === "text") {
                    div.innerHTML = `<label class="form-label">${entity.label}</label>
                    <input type="text" class="form-control">`
                } else if (entity.type === "checkbox") {
                    div.className += "form-check"
                    div.innerHTML = `<input type="checkbox" class="form-check-input" id="exampleCheck1">
                    <label class="form-check-label" for="exampleCheck1">${entity.label}</label>`
                } else if (entity.type === "radio") {
                    div.innerHTML += `<p>${entity.label}</p>`
                    entity.options.items.forEach((option) => {
                        div.innerHTML += `<div class="form-check">
                            <input class="form-check-input" type="radio" name="${option.label}" id="${option.value}">
                            <label class="form-check-label" for="${option.value}">
                            ${option.label}
                            </label>
                        </div>`
                    })
                } else if (entity.type === "singleSelect") {
                    div.innerHTML = `<div class="dropdown">
                        <button class="btn btn-secondary dropdown-toggle" type="button" id="${entity.field}" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 0.8rem">
                            ${entity.label}
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                            ${entity.options?.autoCompleteFields?.map(f => `<li><a class="dropdown-item" style="font-size: 0.8rem" href="#">${f.label}</a></li>`).join('')}
                        </ul>
                    </div>
                    `
                }
            })
            form.innerHTML += `<button type="submit" class="btn btn-success" style="font-size: 0.8rem">Save</button>`
        }
    
        window.addEventListener('message', event => {
            const message = event.data;
            if (message.action === "config-data") {
                updateMainNav(message.data.pages);
                updateConfigTabs(message.data.pages.configuration.tabs)
                // update config forms
                message.data.pages.configuration.tabs.forEach((tab) => updateEntityForm(tab.entity, tab.name))
                // update input forms
                message.data.pages.inputs.services.forEach((srv) => updateEntityForm(srv.entity, srv.name))
                toggleConfigNav(showConfigTab)
                showForm(activeForm)
            }
        })

    </script>
</body>

</html>